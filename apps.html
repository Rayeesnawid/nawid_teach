<script>
const appDataURL = "https://script.google.com/macros/s/AKfycbyAl4RiehwRT6NAaNOD1MT0uHBJE8sv3r1rvE1i1OcUdSa-9wTYuTEArIEKNZujRNhP/exec";

function getQueryParam(key) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(key);
}

function saveToLocal(data) {
  localStorage.setItem("apps_cache", JSON.stringify(data));
}

function loadFromLocal() {
  const cache = localStorage.getItem("apps_cache");
  if (cache) {
    return JSON.parse(cache);
  }
  return null;
}

function renderApp(app, index) {
  const container = document.getElementById("app-container");
  const appCard = document.createElement("div");
  appCard.className = "app-card";

  const shareLink = `${window.location.origin}${window.location.pathname}?id=${index}`;

  appCard.innerHTML = `
    <h3>${app.name}</h3>
    <p>${app.description}</p>
    <button onclick="window.location.href='${app.download}'">
      <i class="fas fa-download"></i> Download
    </button>
    <button onclick="copyToClipboard('${shareLink}')">
      <i class="fas fa-link"></i> Copy Link
    </button>
  `;

  container.appendChild(appCard);
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert("Link copied!");
  });
}

function displayApps(apps) {
  const id = getQueryParam("id");
  const container = document.getElementById("app-container");
  container.innerHTML = "";

  if (id !== null && !isNaN(id) && apps[parseInt(id)]) {
    renderApp(apps[parseInt(id)], parseInt(id));
  } else {
    apps.forEach((app, i) => {
      renderApp(app, i);
    });
  }
}

function fetchApps() {
  fetch(appDataURL)
    .then(res => res.json())
    .then(data => {
      if (Array.isArray(data)) {
        saveToLocal(data);
        displayApps(data);
      } else {
        console.error("Invalid data format:", data);
      }
    })
    .catch(err => {
      console.error("Network error, loading from cache:", err);
      const cached = loadFromLocal();
      if (cached) {
        displayApps(cached);
      } else {
        document.getElementById("app-container").innerText = "Failed to load apps.";
      }
    });
}

fetchApps();
</script>
